<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Client | MVRMS</title>
    <link rel="stylesheet" href="/MVRMS/client/css/client.css">
    <link rel="icon" type="image/png" href="/MVRMS/client/images/logo.png">
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/MVRMS/client/images/logo.png" alt="Logo" class="sidebar-logo">
                <h2>MVRMS</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/MVRMS/client/pages/client/dashboard.html" class="nav-item active">Dashboard</a>
                <a href="/MVRMS/client/pages/client/browse-vehicles.html" class="nav-item">Browse Vehicles</a>
                <a href="/MVRMS/client/pages/client/make-reservation.html" class="nav-item">Make Reservation</a>
                <a href="/MVRMS/client/pages/client/my-bookings.html" class="nav-item">My Bookings</a>
                <a href="/MVRMS/client/pages/client/handle-payment.html" class="nav-item">Payments</a>
                <a href="/MVRMS/client/pages/client/profile.html" class="nav-item">Profile</a>
                <a href="/MVRMS/client/pages/client/rental-history.html" class="nav-item">Rental History</a>
                <a href="/MVRMS/client/pages/login.html" class="nav-item logout">Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <input type="text" id="globalSearch" placeholder="Search...">
                </div>
                <!-- Updated user menu with functional notification, settings, and profile components -->
                <div class="user-menu">
                    <!-- Notification Bell -->
                    <div class="notification-container">
                        <button class="notification-btn" id="notificationBell" title="Notifications">
                            üîî
                            <span class="notification-badge" id="notificationBadge">2</span>
                        </button>
                        <div class="notification-panel" id="notificationPanel">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="close-btn" onclick="closeNotifications()">√ó</button>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <div class="notification-item">
                                    <div class="notification-content">
                                        <p class="notification-title">Booking Confirmed</p>
                                        <p class="notification-message">Your booking has been confirmed</p>
                                        <span class="notification-time">2 hours ago</span>
                                    </div>
                                </div>
                                <div class="notification-item">
                                    <div class="notification-content">
                                        <p class="notification-title">Payment Reminder</p>
                                        <p class="notification-message">Payment due for booking #B456</p>
                                        <span class="notification-time">1 day ago</span>
                                    </div>
                                </div>
                            </div>
                            <div class="notification-footer">
                                <button class="view-all-btn" onclick="viewAllNotifications()">View All</button>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="settings-container">
                        <button class="settings-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
                        <div class="settings-panel" id="settingsPanel">
                            <div class="settings-header">
                                <h3>Settings</h3>
                                <button class="close-btn" onclick="closeSettings()">√ó</button>
                            </div>
                            <div class="settings-content">
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="emailNotifications" checked> Email Notifications
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="darkMode"> Dark Mode
                                    </label>
                                </div>
                                <div class="setting-item">
                                    <label>
                                        <input type="checkbox" id="soundAlerts" checked> Sound Alerts
                                    </label>
                                </div>
                                <div class="setting-divider"></div>
                                <div class="setting-item">
                                    <a href="#" onclick="openAccountSettings(event)">Account Settings</a>
                                </div>
                                <div class="setting-item">
                                    <a href="#" onclick="openPrivacy(event)">Privacy & Security</a>
                                </div>
                                <div class="setting-item">
                                    <a href="#" onclick="openHelp(event)">Help & Support</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Profile -->
                    <div class="user-profile-container">
                        <button class="user-profile-btn" id="profileBtn">
                            <div class="profile-avatar">üë§</div>
                            <span id="currentUsername">Client</span>
                        </button>
                        <div class="profile-panel" id="profilePanel">
                            <div class="profile-header">
                                <div class="profile-avatar-large">üë§</div>
                                <div class="profile-info">
                                    <h4 id="profileName">Client User</h4>
                                    <p id="profileUsername">client-user</p>
                                    <p class="profile-role">Customer</p>
                                </div>
                            </div>
                            <div class="profile-divider"></div>
                            <div class="profile-menu">
                                <a href="/MVRMS/client/pages/client/profile.html">View Profile</a>
                                <a href="/MVRMS/client/pages/client/profile.html">Edit Profile</a>
                                <a href="#" onclick="changePassword(event)">Change Password</a>
                            </div>
                            <div class="profile-divider"></div>
                            <div class="logout-section">
                                <button class="logout-link" onclick="logout()">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <h1>Welcome to Your Dashboard</h1>

                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Active Bookings</h3>
                        <p class="card-number" id="activeBookings">0</p>
                    </div>
                    <div class="card">
                        <h3>Completed Rentals</h3>
                        <p class="card-number" id="completedRentals">0</p>
                    </div>
                    <div class="card">
                        <h3>Total Spent</h3>
                        <p class="card-number" id="totalSpent">‚Ç±0</p>
                    </div>
                    <div class="card">
                        <h3>Payment Status</h3>
                        <p class="card-status" id="paymentStatus">Paid</p>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h2>Recent Bookings</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Booking Date</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentBookingsTable">
                            <tr>
                                <td>Honda CB150</td>
                                <td>Jan 8, 2025</td>
                                <td>3 days</td>
                                <td><span class="badge active">Active</span></td>
                                <td><a href="/MVRMS/client/pages/client/my-bookings.html" class="link">View</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="/MVRMS/client/js/backend.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            /* ================= AUTH ================= */
            const user = JSON.parse(localStorage.getItem("currentUser"));
            if (!user || !user.user_id) {
                window.location.href = "/MVRMS/client/pages/login.html";
                return;
            }

            /* ================= USER INFO ================= */
            const currentUsername = document.getElementById("currentUsername");
            const profileName = document.getElementById("profileName");
            const profileUsername = document.getElementById("profileUsername");

            if (currentUsername) currentUsername.textContent = user.username;
            if (profileName) profileName.textContent = user.name || user.username;
            if (profileUsername) profileUsername.textContent = user.username;

            /* ================= GLOBAL SEARCH ================= */
            const globalSearch = document.getElementById("globalSearch");
            if (globalSearch) {
                globalSearch.addEventListener("keyup", function () {
                    const keyword = this.value.toLowerCase();
                    document.querySelectorAll("table tbody tr").forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(keyword) ? "" : "none";
                    });
                });
            }

            /* ================= NOTIFICATIONS ================= */
            const bell = document.getElementById("notificationBell");
            const panel = document.getElementById("notificationPanel");
            const list = document.getElementById("notificationList");
            const badge = document.getElementById("notificationBadge");

            function loadNotifications() {
                if (!list) return;

                fetch(`/MVRMS/api/get-notifications.php?user_id=${user.user_id}`)
                    .then(res => res.json())
                    .then(data => {
                        list.innerHTML = "";
                        let unread = 0;

                        data.forEach(n => {
                            if (!n.is_read) unread++;
                            list.innerHTML += `
                        <div class="notification-item">
                            <div class="notification-content">
                                <p class="notification-title">${n.title}</p>
                                <p class="notification-message">${n.message}</p>
                                <span class="notification-time">
                                    ${new Date(n.created_at).toLocaleString()}
                                </span>
                            </div>
                        </div>`;
                        });

                        if (badge) {
                            badge.textContent = unread;
                            badge.style.display = unread ? "flex" : "none";
                        }
                    });
            }

            if (bell && panel) {
                bell.addEventListener("click", e => {
                    e.stopPropagation();
                    panel.classList.toggle("active");

                    fetch("/MVRMS/api/mark-notifications-read.php", {
                        method: "POST",
                        body: new URLSearchParams({ user_id: user.user_id })
                    });

                    if (badge) badge.style.display = "none";
                });

                document.addEventListener("click", () => panel.classList.remove("active"));
                loadNotifications();
            }

            /* ================= SETTINGS ================= */
            const emailCheckbox = document.getElementById("emailNotifications");
            const darkModeCheckbox = document.getElementById("darkMode");
            const soundCheckbox = document.getElementById("soundAlerts");
            const settingsBtn = document.getElementById("settingsBtn");
            const settingsPanel = document.getElementById("settingsPanel");

            function enableDarkMode() {
                document.body.classList.add("dark-mode");
            }

            function disableDarkMode() {
                document.body.classList.remove("dark-mode");
            }

            function toggleDarkMode() {
                darkModeCheckbox.checked ? enableDarkMode() : disableDarkMode();
            }

            function loadSettings() {
                if (!emailCheckbox) return;

                fetch(`/MVRMS/api/get-settings.php?user_id=${user.user_id}`)
                    .then(res => res.json())
                    .then(data => {
                        emailCheckbox.checked = data.email_notifications == 1;
                        darkModeCheckbox.checked = data.dark_mode == 1;
                        soundCheckbox.checked = data.sound_alerts == 1;
                        if (darkModeCheckbox.checked) enableDarkMode();
                    });
            }

            function saveSettings() {
                fetch("/MVRMS/api/save-settings.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        user_id: user.user_id,
                        email: emailCheckbox.checked ? 1 : 0,
                        dark: darkModeCheckbox.checked ? 1 : 0,
                        sound: soundCheckbox.checked ? 1 : 0
                    })
                });
            }

            if (emailCheckbox && darkModeCheckbox && soundCheckbox) {
                [emailCheckbox, darkModeCheckbox, soundCheckbox].forEach(cb => {
                    cb.addEventListener("change", () => {
                        saveSettings();
                        if (cb === darkModeCheckbox) toggleDarkMode();
                    });
                });
                loadSettings();
            }

            if (settingsBtn && settingsPanel) {
                settingsBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    settingsPanel.classList.toggle("active");
                });
                document.addEventListener("click", () => settingsPanel.classList.remove("active"));
            }

            /* ================= PROFILE DROPDOWN ================= */
            const profileBtn = document.getElementById("profileBtn");
            const profilePanel = document.getElementById("profilePanel");

            if (profileBtn && profilePanel) {
                profileBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    profilePanel.classList.toggle("active");
                });
                document.addEventListener("click", () => profilePanel.classList.remove("active"));
            }

            /* ================= DASHBOARD DATA ================= */
            fetch(`/MVRMS/api/get-dashboard.php?user_id=${user.user_id}`)
                .then(res => res.json())
                .then(data => {
                    const a = document.getElementById("activeBookings");
                    const c = document.getElementById("completedRentals");
                    const t = document.getElementById("totalSpent");
                    const p = document.getElementById("paymentStatus");

                    if (a) a.textContent = data.activeBookings;
                    if (c) c.textContent = data.completedRentals;
                    if (t) t.textContent = `‚Ç±${Number(data.totalSpent).toLocaleString()}`;
                    if (p) p.textContent = data.paymentStatus;
                });

            /* ================= RECENT BOOKINGS ================= */
            const recentTable = document.getElementById("recentBookingsTable");
            if (recentTable) {
                fetch(`/MVRMS/api/get-recent-bookings.php?user_id=${user.user_id}`)
                    .then(res => res.json())
                    .then(data => {
                        recentTable.innerHTML = "";

                        if (!data.length) {
                            recentTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align:center;">No recent bookings</td>
                        </tr>`;
                            return;
                        }

                        data.forEach(b => {
                            recentTable.innerHTML += `
                        <tr>
                            <td>${b.vehicle_name}</td>
                            <td>${new Date(b.pickup_date).toLocaleDateString()}</td>
                            <td>${b.total_days} days</td>
                            <td><span class="badge active">${b.status}</span></td>
                            <td>
                                <a href="/MVRMS/client/pages/client/my-bookings.html" class="link">View</a>
                            </td>
                        </tr>`;
                        });
                    });
            }

        });
        function viewAllNotifications() {
            window.location.href = "/MVRMS/client/pages/client/notifications.html";
        }
        function changePassword(event) {
            event.preventDefault();
            window.location.href = "/MVRMS/client/pages/client/change-password.html";
        }


    </script>


</body>

</html>