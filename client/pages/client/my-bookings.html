<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Client | MVRMS</title>
    <link rel="stylesheet" href="/MVRMS/client/css/client.css">
    <link rel="icon" type="image/png" href="/MVRMS/client/images/logo.png">
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/MVRMS/client/images/logo.png" alt="Logo" class="sidebar-logo">
                <h2>MVRMS</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/MVRMS/client/pages/client/dashboard.html" class="nav-item">Dashboard</a>
                <a href="/MVRMS/client/pages/client/browse-vehicles.html" class="nav-item">Browse Vehicles</a>
                <a href="/MVRMS/client/pages/client/make-reservation.html" class="nav-item">Make Reservation</a>
                <a href="/MVRMS/client/pages/client/my-bookings.html" class="nav-item active">My Bookings</a>
                <a href="/MVRMS/client/pages/client/handle-payment.html" class="nav-item">Payments</a>
                <a href="/MVRMS/client/pages/client/profile.html" class="nav-item">Profile</a>
                <a href="/MVRMS/client/pages/client/rental-history.html" class="nav-item">Rental History</a>
                <a href="/MVRMS/client/pages/login.html" class="nav-item logout">Logout</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <input type="text" id="searchBookings" placeholder="Search bookings...">
                </div>
                <div class="user-info">
                    <span id="currentUsername">Client</span>
            </header>

            <div class="page-content">
                <h1>My Bookings</h1>

                <div class="filter-section">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="Active">Active</button>
                    <button class="filter-btn" data-filter="Pending">Pending</button>
                    <button class="filter-btn" data-filter="Completed">Completed</button>
                    <button class="filter-btn" data-filter="Cancelled">Cancelled</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Vehicle</th>
                            <th>Pickup Date</th>
                            <th>Return Date</th>
                            <th>Total Cost</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable">
                        <!-- rows here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="/MVRMS/client/js/backend.js"></script>
    <script>
        function renderBookings(bookings) {
            const table = document.getElementById("bookingsTable");
            table.innerHTML = "";

            if (!bookings || bookings.length === 0) {
                table.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center;">
                    No bookings found
                </td>
            </tr>
        `;
                return;
            }

            bookings.forEach(b => {
                table.innerHTML += `
            <tr>
                <td>BK-${b.reservation_id}</td>
                <td>${b.vehicle_name}</td>
                <td>${b.pickup_date}</td>
                <td>${b.return_date}</td>
                <td>₱${Number(b.total_cost).toLocaleString()}</td>
                <td>${b.status}</td>
                <td>
                    ${b.status === "Active"
                        ? `<a href="handle-payment.html?reservation_id=${b.reservation_id}" class="btn-pay">Pay</a>`
                        : "-"
                    }
                </td>
            </tr>
        `;
            });
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser || !currentUser.user_id) {
                alert("Please login again.");
                window.location.href = "/MVRMS/client/pages/login.html";
                return;
            }

            document.getElementById("currentUsername").textContent = currentUser.username;

            let allBookings = [];

            function renderBookings(bookings) {
                const table = document.getElementById("bookingsTable");
                table.innerHTML = "";

                if (!bookings || bookings.length === 0) {
                    table.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center;">No bookings found</td>
                </tr>
            `;
                    return;
                }

                bookings.forEach(b => {
                    table.innerHTML += `
                <tr>
                    <td>BK-${b.reservation_id}</td>
                    <td>${b.vehicle_name}</td>
                    <td>${b.pickup_date}</td>
                    <td>${b.return_date}</td>
                    <td>₱${Number(b.total_cost).toLocaleString()}</td>
                    <td>${b.status}</td>
                    <td>
                        ${b.status === "Active"
                            ? `<a href="handle-payment.html?reservation_id=${b.reservation_id}" class="btn-pay">Pay</a>`
                            : "-"
                        }
                    </td>
                </tr>
            `;
                });
            }

            function applyFilter(status) {
                if (status === "all") {
                    renderBookings(allBookings);
                } else {
                    renderBookings(allBookings.filter(b => b.status === status));
                }
            }

            fetch(`/MVRMS/api/get-my-bookings.php?user_id=${currentUser.user_id}`)
                .then(res => res.json())
                .then(data => {
                    allBookings = data;
                    renderBookings(allBookings);
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to load bookings");
                });

            document.querySelectorAll(".filter-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    applyFilter(btn.dataset.filter);
                });
            });

        });
    </script>

</body>

</html>