<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - MVRMS</title>
    <link rel="stylesheet" href="../css/client.css">
    <link rel="icon" type="image/png" href="../images/logo.png">
    <style>
        .signup-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .camera-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            background: #000;
            display: none;
            margin: 15px auto;
        }
        #canvas {
            display: none;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .camera-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-camera-start {
            background: #28a745;
            color: white;
        }
        .btn-camera-stop {
            background: #dc3545;
            color: white;
            display: none;
        }
        .btn-camera-capture {
            background: #007bff;
            color: white;
            display: none;
        }
        .captured-id-preview {
            display: none;
            text-align: center;
            margin: 15px 0;
        }
        .captured-id-preview.show {
            display: block;
        }
        .captured-id-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #28a745;
        }
        .id-status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .id-status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .id-status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .id-status.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }
        .id-form-fields {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .id-form-fields.show {
            display: block;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .nav-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-back {
            background: #6c757d;
            color: white;
        }
        .btn-next {
            background: #007bff;
            color: white;
        }
        .btn-submit {
            background: #28a745;
            color: white;
        }
        .skip-link {
            text-align: center;
            margin-top: 15px;
        }
        .skip-link a {
            color: #6c757d;
            text-decoration: underline;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .signup-steps {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <a href="/MVRMS/client/index.html">
                        <img src="../images/logo.png" alt="Rento Logo" class="logo">
                        <h1>MVRMS</h1>
                    </a>
                </div>
                <nav class="nav">
                    <a href="/MVRMS/client/index.html" class="nav-link">About Us</a>
                    <a href="/MVRMS/client/pages/login.html" class="nav-link">Login</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="auth-page">
        <div class="auth-container">
            <div class="auth-left">
                <img src="../images/logo.png" alt="Rento Logo" class="auth-logo">
                <h2>Sign Up Form</h2>
                <p>Motor Vehicle Rental Services</p>
            </div>

            <div class="auth-right">
                <div class="form-box">
                    <h3>MVRMS</h3>
                    <p>Rental Management System</p>

                    <div class="signup-steps">
                        <div class="step active" id="step1-indicator">
                            <span class="step-number">1</span>
                            <span>Account Info</span>
                        </div>
                        <div class="step" id="step2-indicator">
                            <span class="step-number">2</span>
                            <span>ID Verification</span>
                        </div>
                    </div>

                    <!-- Step 1: Account Information -->
                    <div class="form-section active" id="step1">
                        <form id="accountForm" class="auth-form">
                            <div class="form-group">
                                <label for="fullname">Full Name</label>
                                <input type="text" id="fullname" name="fullname" placeholder="Enter your full name" required>
                            </div>

                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" placeholder="Enter your email" required>
                            </div>

                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" placeholder="Enter your phone number" required>
                            </div>

                            <div class="form-group">
                                <label for="signup-username">Username</label>
                                <input type="text" id="signup-username" name="signup-username" placeholder="Enter your username" required>
                            </div>

                            <div class="form-group">
                                <label for="signup-password">Password</label>
                                <input type="password" id="signup-password" name="signup-password" placeholder="Choose a password" required>
                                <small>Must be 8+ chars with at least 1 number</small>
                            </div>

                            <div class="form-group">
                                <label for="confirm-password">Confirm Password</label>
                                <input type="password" id="confirm-password" name="confirm-password" placeholder="Re-enter your password" required>
                            </div>

                            <div class="form-group checkbox">
                                <input type="checkbox" id="terms-agree" name="terms-agree" required>
                                <label for="terms-agree">I agree to the Terms and Privacy Policy</label>
                            </div>

                            <button type="submit" class="btn-login btn-next">Next: Verify ID</button>
                        </form>
                    </div>

                    <!-- Step 2: ID Verification -->
                    <div class="form-section" id="step2">
                        <div class="camera-section">
                            <h4>Scan Your Valid ID</h4>
                            <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                                Use your camera to scan a valid government ID (Driver's License, Passport, National ID, TIN, SSS, etc.)
                            </p>

                            <div id="idStatus" class="id-status"></div>

                            <video id="video" playsinline autoplay></video>
                            <canvas id="canvas"></canvas>

                            <div class="camera-controls">
                                <button type="button" class="btn-camera-start" id="startCameraBtn" onclick="startCamera()">Start Camera</button>
                                <button type="button" class="btn-camera-stop" id="stopCameraBtn" onclick="stopCamera()">Stop Camera</button>
                                <button type="button" class="btn-camera-capture" id="captureBtn" onclick="captureID()">Capture ID</button>
                            </div>

                            <div class="captured-id-preview" id="capturedPreview">
                                <h5>Captured ID:</h5>
                                <img id="capturedImage" alt="Captured ID">
                                <div style="margin-top: 10px;">
                                    <button type="button" class="btn-camera-start" onclick="retakePhoto()">Retake Photo</button>
                                </div>
                            </div>
                        </div>

                        <div class="id-form-fields" id="idFormFields">
                            <h4>Confirm Your ID Details</h4>
                            <form id="idForm" class="auth-form">
                                <div class="form-group">
                                    <label for="idType">ID Type *</label>
                                    <select id="idType" required>
                                        <option value="">Select ID Type</option>
                                        <option value="drivers_license">Driver's License</option>
                                        <option value="passport">Passport</option>
                                        <option value="national_id">National ID</option>
                                        <option value="tin">TIN ID</option>
                                        <option value="sss">SSS ID</option>
                                        <option value="other">Other Valid ID</option>
                                    </select>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="idNumber">ID Number *</label>
                                        <input type="text" id="idNumber" placeholder="e.g., DL-123456789" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="idDOB">Date of Birth *</label>
                                        <input type="date" id="idDOB" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="idExpiry">Expiration Date *</label>
                                        <input type="date" id="idExpiry" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="idCountry">Issuing Country *</label>
                                        <input type="text" id="idCountry" value="Philippines" required>
                                    </div>
                                </div>

                                <div class="nav-buttons">
                                    <button type="button" class="btn-back" onclick="goToStep(1)">Back</button>
                                    <button type="submit" class="btn-submit">Create Account</button>
                                </div>
                            </form>
                        </div>

                        <div class="skip-link">
                            <a onclick="skipIDVerification()">Skip for now (verify later)</a>
                        </div>
                    </div>

                    <p class="auth-link">Already have an account? <a href="/MVRMS/client/pages/login.html">Log In</a></p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Motor Vehicle Rental Management System. All rights reserved.</p>
        </div>
    </footer>

   <script src="/MVRMS/client/js/backend.js"></script>
   <script src="/MVRMS/client/js/idscanner.js"></script>

                <script>
            /* =========================
            GLOBAL VARIABLES
            ========================= */
            let accountData = null;
            let capturedIDImage = null;
            let videoStream = null;
            let isCameraRunning = false;

            /* =========================
            STEP 1 – ACCOUNT INFO
            ========================= */
            document.getElementById("accountForm").addEventListener("submit", function (e) {
                e.preventDefault();

                const fullname = document.getElementById("fullname").value.trim();
                const email = document.getElementById("email").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const username = document.getElementById("signup-username").value.trim();
                const password = document.getElementById("signup-password").value;
                const confirmPassword = document.getElementById("confirm-password").value;

                if (!fullname || !email || !phone || !username || !password) {
                    alert("Please fill out all fields");
                    return;
                }

                if (password !== confirmPassword) {
                    alert("Passwords do not match");
                    return;
                }

                if (password.length < 8 || !/\d/.test(password)) {
                    alert("Password must be at least 8 characters and contain a number");
                    return;
                }

                accountData = {
                    fullname,
                    email,
                    phone,
                    username,
                    password
                };

                console.log("STEP 1 SAVED:", accountData);
                goToStep(2);
            });

            /* =========================
            STEP 2 – ID FORM SUBMIT
            ========================= */
            document.getElementById("idForm").addEventListener("submit", function (e) {
                e.preventDefault();

                if (!accountData) {
                    alert("Please complete Step 1 first");
                    goToStep(1);
                    return;
                }

                if (!capturedIDImage) {
                    alert("Please capture your ID first");
                    return;
                }

                const idType = document.getElementById("idType").value;
                const idNumber = document.getElementById("idNumber").value;
                const idDOB = document.getElementById("idDOB").value;
                const idExpiry = document.getElementById("idExpiry").value;
                const idCountry = document.getElementById("idCountry").value;

                const validation = validateIDData({
                    idType,
                    idNumber,
                    dob: idDOB,
                    expiry: idExpiry
                });

                if (!validation.valid) {
                    alert(validation.messages.join("\n"));
                    return;
                }

                const newUser = {
                    ...accountData,
                    role: "client",
                    idVerified: true,
                    idData: {
                        type: idType,
                        number: idNumber,
                        dob: idDOB,
                        expiry: idExpiry,
                        country: idCountry,
                        image: capturedIDImage
                    }
                };

                console.log("FINAL USER:", newUser);

                /* ===== SEND TO PHP ===== */
                fetch("/MVRMS/api/register.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newUser)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        alert("Account created successfully!");
                        window.location.href = "/MVRMS/client/pages/login.html";
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Registration failed");
                });
            });

            /* =========================
            STEP NAVIGATION
            ========================= */
            function goToStep(step) {
                document.querySelectorAll(".form-section").forEach(s => s.classList.remove("active"));
                document.querySelectorAll(".step").forEach(s => s.classList.remove("active", "completed"));

                if (step === 1) {
                    document.getElementById("step1").classList.add("active");
                    document.getElementById("step1-indicator").classList.add("active");
                    stopCamera();
                } else {
                    document.getElementById("step2").classList.add("active");
                    document.getElementById("step1-indicator").classList.add("completed");
                    document.getElementById("step2-indicator").classList.add("active");
                }
            }

            /* =========================
            CAMERA FUNCTIONS
            ========================= */
            async function startCamera() {
                const video = document.getElementById("video");

                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = videoStream;
                video.style.display = "block";
                await video.play();

                isCameraRunning = true;
                document.getElementById("startCameraBtn").style.display = "none";
                document.getElementById("stopCameraBtn").style.display = "inline-block";
                document.getElementById("captureBtn").style.display = "inline-block";
            }

            function stopCamera() {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                isCameraRunning = false;
            }

            function captureID() {
                if (!isCameraRunning) return;

                const video = document.getElementById("video");
                const canvas = document.getElementById("canvas");
                const ctx = canvas.getContext("2d");

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                capturedIDImage = canvas.toDataURL("image/jpeg", 0.9);
                document.getElementById("capturedImage").src = capturedIDImage;
                document.getElementById("capturedPreview").classList.add("show");

                stopCamera();
                document.getElementById("idFormFields").classList.add("show");
            }

            function retakePhoto() {
                capturedIDImage = null;
                document.getElementById("capturedPreview").classList.remove("show");
                document.getElementById("idFormFields").classList.remove("show");
                startCamera();
            }

            /* =========================
            ID VALIDATION
            ========================= */
            function validateIDData(data) {
                const messages = [];
                if (!data.idType) messages.push("ID Type required");
                if (!data.idNumber) messages.push("ID Number required");
                if (!data.dob) messages.push("Date of Birth required");
                if (!data.expiry) messages.push("Expiration Date required");

                return {
                    valid: messages.length === 0,
                    messages
                };
            }
            </script>


</body>
</html>