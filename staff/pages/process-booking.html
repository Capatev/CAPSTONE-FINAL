<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Booking - MVRS Staff</title>
    <link rel="stylesheet" href="/MVRMS/staff/css/staff.css">
</head>

<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/MVRMS/client/images/logo.png" class="logo">
                <p class="logo-text">STAFF</p>
            </div>

            <nav class="menu">
                <a href="/MVRMS/staff/staff.html" class="menu-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/MVRMS/staff/pages/process-booking.html" class="menu-item active">
                    <span class="icon">üìù</span>
                    <span>Process Booking</span>
                </a>
                <a href="/MVRMS/staff/pages/vehicle-availability.html" class="menu-item">
                    <span class="icon">üöô</span>
                    <span>Vehicle Availability</span>
                </a>
                <a href="/MVRMS/staff/pages/verify-clients.html" class="menu-item">
                    <span class="icon">‚úì</span>
                    <span>Verify Clients</span>
                </a>
                <a href="/MVRMS/staff/pages/asset-management.html" class="menu-item">
                    <span class="icon">üì¶</span>
                    <span>Asset Management</span>
                </a>
                <div style="border-top: 1px solid #ddd; margin: 20px 0; padding-top: 20px;">
                    <p style="font-size: 12px; color: #888; padding: 0 15px; margin-bottom: 10px;">BILLING</p>
                    <a href="/MVRMS/staff/pages/handle-billing.html" class="menu-item">
                        <span class="icon">üí∞</span>
                        <span>Handle Billing</span>
                    </a>
                    <a href="/MVRMS/staff/pages/payment-methods.html" class="menu-item">
                        <span class="icon">üí≥</span>
                        <span>Payment Methods</span>
                    </a>
                </div>
            </nav>

            <button class="logout-btn">Logout</button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1>Process Booking</h1>
                <div class="user-info">
                    <span class="username">staff-user</span>
                    <div class="avatar">üë§</div>
                </div>
            </header>

            <div class="content">
                <div class="section">
                    <div class="section-header">
                        <h2>New Booking Request</h2>
                        <button class="btn btn-primary" onclick="showNewBookingModal()">+ Create Booking</button>
                    </div>

                    <div class="header-actions">
                        <div class="search-bar">
                            <input type="text" id="searchBooking" placeholder="Search bookings..." class="search-input">
                        </div>
                        <div class="filter-group">
                            <select id="filterStatus" class="filter-select">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Client Name</th>
                                <th>Vehicle</th>
                                <th>Dates</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px;">Loading bookings...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- New Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Booking</h2>
                <button class="close-btn" onclick="closeBookingModal()">√ó</button>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <label for="clientName">Client Name *</label>
                    <input type="text" id="clientName" required placeholder="Enter client name">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="clientEmail">Email *</label>
                        <input type="email" id="clientEmail" required placeholder="client@example.com">
                    </div>
                    <div class="form-group">
                        <label for="clientPhone">Phone *</label>
                        <input type="tel" id="clientPhone" required placeholder="09123456789">
                    </div>
                </div>

                <div class="form-group">
                    <label for="vehicleSelect">Select Vehicle *</label>
                    <select id="vehicleSelect" required>
                        <option value="">Choose a vehicle...</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pickupDate">Pickup Date *</label>
                        <input type="date" id="pickupDate" required>
                    </div>
                    <div class="form-group">
                        <label for="returnDate">Return Date *</label>
                        <input type="date" id="returnDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="rentalDays">Rental Days</label>
                    <input type="number" id="rentalDays" disabled placeholder="Auto-calculated">
                </div>

                <div class="form-group">
                    <label for="totalCost">Total Cost</label>
                    <input type="text" id="totalCost" disabled placeholder="Auto-calculated">
                </div>

                <div class="form-group">
                    <label for="notes">Special Notes</label>
                    <textarea id="notes" placeholder="Any special requests or notes..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Booking</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Motor Vehicle Rental Management System - Staff Interface.</p>
    </footer>
    <script>
        /* üî• FORCE OVERRIDE ‚Äî kahit anong backend.js pa yan */
        window.API_BASE_URL = "/MVRMS/api";

        /* block old staff/php/api calls */
        const _fetch = window.fetch;
        window.fetch = function (url, options) {
            if (typeof url === "string" && url.includes("/staff/php/api")) {
                url = url.replace("/staff/php/api", "/api");
            }
            return _fetch(url, options);
        };
    </script>

    <script src="/MVRMS/staff/js/backend.js"></script>
    <script>
        document.getElementById("searchBooking")?.addEventListener("input", (e) => {
            filterBookings(e.target.value);
        });

        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = "flex";
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = "none";
            }
        }

        /**
         * Process Booking Page Logic (INLINE)
         * Uses global db from backend.js
         */

        document.addEventListener("DOMContentLoaded", async () => {
            await initializeStaffDB();
            populateVehicleSelect();
            populateBookings();

            document.getElementById("pickupDate")?.addEventListener("change", calculateCost);
            document.getElementById("returnDate")?.addEventListener("change", calculateCost);
            document.getElementById("vehicleSelect")?.addEventListener("change", calculateCost);

            document
                .getElementById("bookingForm")
                ?.addEventListener("submit", submitBooking);
        });

        /* ===============================
           VEHICLE SELECT
        ================================ */
        function populateVehicleSelect() {
            const select = document.getElementById("vehicleSelect");
            if (!select) return;

            select.innerHTML = `<option value="">Choose a vehicle...</option>`;

            const availableVehicles = db.vehicles.filter(
                v => v.status === "available"
            );

            console.log("Available vehicles:", availableVehicles); // DEBUG

            availableVehicles.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.id;
                opt.textContent = `${v.brand} ${v.model} ‚Äì ‚Ç±${v.dailyRate}/day`;
                select.appendChild(opt);
            });
        }

        /* ===============================
           COST CALCULATION
        ================================ */
        function calculateCost() {
            const vehicleId = document.getElementById("vehicleSelect")?.value;
            const pickupDate = document.getElementById("pickupDate")?.value;
            const returnDate = document.getElementById("returnDate")?.value;

            if (!vehicleId || !pickupDate || !returnDate) return;

            const vehicle = db.vehicles.find(v => v.id == vehicleId);
            if (!vehicle) return;

            const start = new Date(pickupDate);
            const end = new Date(returnDate);
            const days = Math.ceil((end - start) / 86400000) + 1;

            document.getElementById("rentalDays").value = days;
            document.getElementById("totalCost").value =
                formatCurrency(days * vehicle.dailyRate);
        }

        /* ===============================
           BOOKINGS TABLE
        ================================ */
        function populateBookings() {
            const tbody = document.getElementById("bookingsTable");
            tbody.innerHTML = "";

            if (db.bookings.length === 0) {
                tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center;padding:20px;">
          No bookings found
        </td>
      </tr>
    `;
                return;
            }

            db.bookings.forEach((b) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${b.booking_id}</td>
      <td>${b.client_name}</td>
      <td>${b.vehicle}</td>
      <td>${formatDate(b.start_date)} - ${formatDate(b.end_date)}</td>
      <td>${createBadge(b.status)}</td>
      <td>${formatCurrency(b.amount)}</td>
      <td>
        <button class="btn btn-sm btn-success">Approve</button>
      </td>
    `;
                tbody.appendChild(tr);
            });
        }



        /* ===============================
           CREATE BOOKING
        ================================ */
        async function submitBooking(e) {
            e.preventDefault();

            const clientName = document.getElementById("clientName").value;
            const vehicleId = document.getElementById("vehicleSelect").value;
            const pickupDate = document.getElementById("pickupDate").value;
            const returnDate = document.getElementById("returnDate").value;
            const notes = document.getElementById("notes").value;

            const vehicle = db.vehicles.find(v => v.id == vehicleId);
            if (!vehicle) return alert("Invalid vehicle");

            const days =
                Math.ceil((new Date(returnDate) - new Date(pickupDate)) / 86400000) + 1;

            const amount = days * vehicle.dailyRate;

            const res = await fetch("/MVRMS/api/reservations.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    clientId: 1, // staff-created booking
                    clientName,
                    vehicle: `${vehicle.brand} ${vehicle.model}`,
                    pickupDate,
                    returnDate,
                    amount
                })
            });

            const data = await res.json();

            if (data.success) {
                alert("Booking created successfully");
                closeBookingModal();
                await initializeStaffDB();
                populateBookings();
            } else {
                alert(data.message || "Failed to create booking");
            }
        }

        /* ===============================
           STATUS ACTIONS
        ================================ */
        async function approveBooking(id) {
            await updateBookingStatus(id, "approved");
            populateBookings();
        }

        async function rejectBooking(id) {
            await updateBookingStatus(id, "rejected");
            populateBookings();
        }

        /* ===============================
           MODAL
        ================================ */
        function showNewBookingModal() {
            openModal("bookingModal");
        }

        function closeBookingModal() {
            closeModal("bookingModal");
        }

        function filterBookings(searchTerm = "") {
            const tbody = document.getElementById("bookingsTable");
            const status = document.getElementById("filterStatus").value;

            tbody.innerHTML = "";

            const filtered = db.bookings.filter(b => {
                const matchSearch =
                    b.client_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    String(b.booking_id).includes(searchTerm);

                // ‚úÖ ALL STATUS LOGIC
                const matchStatus = status === "" || b.status === status;

                return matchSearch && matchStatus;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center;padding:20px;">
          No bookings found
        </td>
      </tr>
    `;
                return;
            }

            filtered.forEach(b => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${b.booking_id}</td>
      <td>${b.client_name}</td>
      <td>${b.vehicle}</td>
      <td>${formatDate(b.start_date)} - ${formatDate(b.end_date)}</td>
      <td>${createBadge(b.status)}</td>
      <td>${formatCurrency(b.amount)}</td>
      <td>
        <button class="btn btn-sm btn-success">Approve</button>
      </td>
    `;
                tbody.appendChild(tr);
            });
        }

    </script>


</body>

</html>